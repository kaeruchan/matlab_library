% Clean all residual data
clear all;
close all;
clc;

% parameter library
N_max = 10000;
M=10; %The number of relay
V=5; %Rician Factor
Omega = 1; 
Pj = 5; %Power of Jammer (dBm)
P0 = 0:20; %Power of Signal (dBm)
gamma_k = 20; %threshold SNR (dBm)
N0 = 0; %Power of noise (dBm)
%beta = 0.5; %time ratio
q = 0.7; % Bernoulli Variance
lambda = 0.1; %Chernoff-bound parameter

% Analysis

pr_anal_sub = zeros(1,length(P0));
pr_simu_sub = zeros(1,length(P0));
pr_simple = zeros(1,length(P0));
pr_anal_sub_infty_3 = zeros(1,length(P0));
pr_anal_sub_infty_5 = zeros(1,length(P0));
pr_anal_sub_infty_7 = zeros(1,length(P0));


%Library (Pr_type_channel_q_N0)

pr_anal_sub_3_3 = [0.613835085573720,0.575056392828032,0.546729173998753,0.527125894156240,0.514078802782212,0.505611104213849,0.500187937953458,0.496727017185669,0.494509550762324,0.493075139187611,0.492134687307344,0.491508168121868,0.491083486727708,0.490790448706056,0.490584667253367,0.490437719585564,0.490331139434502,0.490252738511156,0.490194338108665,0.490150356827156,0.490116921318457];

pr_simu_sub_3_3 = [0.673500000000000,0.630400000000000,0.578700000000000,0.552100000000000,0.525200000000000,0.505600000000000,0.507300000000000,0.501000000000000,0.481500000000000,0.497700000000000,0.485600000000000,0.493500000000000,0.489000000000000,0.483600000000000,0.491400000000000,0.492900000000000,0.487000000000000,0.495600000000000,0.489000000000000,0.491300000000000,0.496700000000000];

pr_anal_sub_6_3 = [0.862249466106955,0.795702112984587,0.726460373525662,0.662895690007503,0.610515078310052,0.570988889429648,0.543109844318719,0.524372694717561,0.512170183283729,0.504362165721250,0.499399066595163,0.496238744350868,0.494210316395969,0.492892270799632,0.492022709915748,0.491439243671376,0.491040752109185,0.490763721235852,0.490567788644359,0.490426948608450,0.490324188903674];

pr_simu_sub_6_3 = [0.783900000000000,0.715500000000000,0.667200000000000,0.615300000000000,0.564100000000000,0.547100000000000,0.519500000000000,0.516600000000000,0.507800000000000,0.495700000000000,0.507500000000000,0.489900000000000,0.502900000000000,0.492800000000000,0.489200000000000,0.486700000000000,0.488100000000000,0.493000000000000,0.489900000000000,0.500700000000000,0.488200000000000];

pr_anal_sub_10_3 = [0.978511198384573,0.949213726297734,0.902124377848550,0.839283737127013,0.767982209122346,0.698018045855122,0.637477721488184,0.590207904513952,0.556102755514096,0.532857058981473,0.517601908981522,0.507811454665662,0.501591030842792,0.497641767150521,0.495118997852687,0.493489588500634,0.492421970944046,0.491710865218074,0.491228855161102,0.490896265083494,0.490662731590287];

pr_simu_sub_10_3 = [0.985400000000000,0.961200000000000,0.916700000000000,0.855800000000000,0.792600000000000,0.711600000000000,0.655000000000000,0.602900000000000,0.562900000000000,0.537700000000000,0.522800000000000,0.508300000000000,0.494200000000000,0.506400000000000,0.503700000000000,0.502600000000000,0.494600000000000,0.494500000000000,0.488200000000000,0.496100000000000,0.490000000000000];

pr_anal_sub_3_5 = [0.401439448721688,0.353057149547646,0.318316294195748,0.294532776781546,0.278809549712552,0.268647721573403,0.262156734618066,0.258021373060446,0.255374712914716,0.253663932158353,0.252542846439039,0.251796251963821,0.251290303933039,0.250941252997001,0.250696169614314,0.250521173789447,0.250394259910652,0.250300906672223,0.250231371404025,0.250179006234925,0.250139198163535];

pr_simu_sub_3_5 = [0.480600000000000,0.411900000000000,0.372000000000000,0.323500000000000,0.295900000000000,0.276900000000000,0.268000000000000,0.263300000000000,0.247300000000000,0.251300000000000,0.244300000000000,0.246900000000000,0.251700000000000,0.246700000000000,0.249400000000000,0.253600000000000,0.246000000000000,0.255000000000000,0.260100000000000,0.246300000000000,0.258100000000000];

pr_anal_sub_6_5 = [0.740692797492951,0.640958189171394,0.545329849406041,0.462352256061696,0.396380596734628,0.347672091315039,0.313762001817046,0.291149284465970,0.276492797189389,0.267142209919732,0.261209711747506,0.257436704525815,0.255016989143206,0.253445556795156,0.252409225750813,0.251714048263791,0.251239354868452,0.250909396681167,0.250676056225744,0.250508340580279,0.250385979643284];

pr_simu_sub_6_5 = [0.800900000000000,0.695300000000000,0.597100000000000,0.499200000000000,0.429700000000000,0.367500000000000,0.326700000000000,0.307100000000000,0.279400000000000,0.271700000000000,0.262700000000000,0.253000000000000,0.254800000000000,0.261900000000000,0.253300000000000,0.252900000000000,0.255300000000000,0.259400000000000,0.251700000000000,0.254200000000000,0.249700000000000];

pr_anal_sub_10_5 = [0.948858715022438,0.888097308166629,0.802543398959815,0.702369771492754,0.600107084847581,0.506821184739377,0.429694389760561,0.371080583899601,0.329454071853622,0.301344357343330,0.282999409621805,0.271265964714690,0.263826954421636,0.259110522433129,0.256100430489240,0.254157467087226,0.252884947708733,0.252037620236498,0.251463400482004,0.251067248905868,0.250789118135442];

pr_simu_sub_10_5 = [0.965300000000000,0.909300000000000,0.835600000000000,0.737700000000000,0.637500000000000,0.537000000000000,0.440000000000000,0.393500000000000,0.342700000000000,0.306400000000000,0.284200000000000,0.276000000000000,0.258900000000000,0.252200000000000,0.255300000000000,0.256800000000000,0.259900000000000,0.253700000000000,0.242500000000000,0.247200000000000,0.251000000000000];

pr_anal_sub_3_7 = [0.225081923415380,0.180095102134668,0.148917551084338,0.128064688623768,0.114482866036651,0.105787710573216,0.100267001705850,0.0967634711360212,0.0945269110491135,0.0930836852722958,0.0921390329788396,0.0915104465476727,0.0910847153145243,0.0907911280774704,0.0905850513288892,0.0904379409108025,0.0903312690693219,0.0902528154895278,0.0901943843443845,0.0901503848610936,0.0901169384481655];

pr_simu_sub_3_7 = [0.298200000000000,0.238400000000000,0.179800000000000,0.151300000000000,0.131600000000000,0.114900000000000,0.107200000000000,0.0971000000000000,0.0993000000000000,0.0931000000000000,0.0925000000000000,0.0931000000000000,0.0936000000000000,0.0919000000000000,0.0933000000000000,0.0899000000000000,0.0912000000000000,0.0894000000000000,0.0900000000000000,0.0910000000000000,0.0904000000000000];

pr_anal_sub_6_7 = [0.595357745397369,0.471377999382534,0.365182706777036,0.281163040288577,0.218663821466838,0.174507780346263,0.144610635010717,0.125015042163743,0.112449404468255,0.104486467759001,0.0994560375043033,0.0962657025202581,0.0942234980103810,0.0928989271606308,0.0920261756321973,0.0914410999054046,0.0910417720435687,0.0907642944902789,0.0905681172619112,0.0904271402050638,0.0903243022259579];

pr_simu_sub_6_7 = [0.669600000000000,0.531400000000000,0.420600000000000,0.321600000000000,0.250200000000000,0.197100000000000,0.160700000000000,0.129400000000000,0.116900000000000,0.110000000000000,0.0987000000000000,0.101600000000000,0.0958000000000000,0.0929000000000000,0.0943000000000000,0.0893000000000000,0.0861000000000000,0.0892000000000000,0.0895000000000000,0.0905000000000000,0.0874000000000000];






for Pindex = 1:length(P0)
    
     % Parameters (dbm --> watt)    
    p_Pj = 10^(Pj/10)*10^(-3);
    p_P0 = 10^(P0(Pindex)/10)*10^(-3);
    p_gamma_k = 10^(gamma_k/10)*10^(-3);
    p_N0 = 10^(N0/10)*10^(-3);
    
    
    % main
    tau1 = 2*(1-q)*q
    
   % tau3

    tau3 = q^2
    

    
    %tau2

    %initial sum part
    sum_tau2=0;
    %sum part
    for k = 0:1:M-2
        for j = 0:1:M-k-2
            
            sum_tau2 = sum_tau2+ (-1)^j *pochhammer(2+k-M,j) /factorial(j) ...
                     * (p_P0*(M-1)/(p_Pj*p_gamma_k))^((j+k)/2) ...
                     * ((p_P0+p_Pj*p_gamma_k)/p_P0)^k ...
                     * besseli(2+j+k-M, 2*V*sqrt(p_P0*p_Pj*(M-1)*p_gamma_k)/(p_P0+p_Pj*p_gamma_k));
            
        end
    end
                 
    tau2 = 2*(1-q)*q*(1 ...
         + exp(-V*(p_P0+(M-1)*p_Pj*p_gamma_k)/(p_P0+p_Pj*p_gamma_k))*(M-1)*(p_P0+p_Pj*p_gamma_k)/p_P0 ...
         * (p_P0*p_Pj*p_gamma_k/((M-1)*(p_P0+p_Pj*p_gamma_k)^2))^(M/2) ...
         * sum_tau2 ...
         - marcumq(sqrt(2*p_P0*V/(p_P0+p_Pj*p_gamma_k)), ...
           sqrt(2*V*(M-1)*p_Pj*p_gamma_k/(p_P0+p_Pj*p_gamma_k)),1))
    
    % tau4
    

    % initial sum part
    sum_tau4=0;
    %sum part
    for k = 0:1:M-1
        for j = 0:1:M-k-1
                  
            sum_tau4 = sum_tau4 ...
                     + (-1)^j * pochhammer(1+k-M,j) / factorial(j) ...
                     * (p_P0*(M-1)/(2*p_Pj*p_gamma_k))^((j+k)/2) ...
                     * ((p_P0 +p_Pj*p_gamma_k)/p_P0)^k ...
                     * besseli(2+j+k-M, ...
                            2*V*sqrt(2*p_P0*p_Pj*(M-1)*p_gamma_k)/(p_P0+p_Pj*p_gamma_k));
        end
    end
    
    tau4 = q^2 ...
           * (1 ...
           + 2^((M-2)/2) ...
           * exp(-(V*(2*p_P0+(M-1)*p_Pj*p_gamma_k)/(p_P0+p_Pj*p_gamma_k))) ...
           * (M-1)*p_Pj*p_gamma_k/p_P0 ...
           * (p_P0*p_Pj*p_gamma_k/((M-1)*(p_P0+p_Pj*p_gamma_k)^2))^(M/2) ...
           * sum_tau4 ...
           - marcumq(2*sqrt(p_P0*V/(p_P0+p_Pj*p_gamma_k)), ...
           sqrt(2*V*(M-1)*p_Pj*p_gamma_k/(p_P0+p_Pj*p_gamma_k)),2))
    
    %analysis result
    pr_anal_sub(Pindex) = 1-(tau1-tau2+tau3-tau4)
    
        %simulation part
    
    %initial parameters
    outage_counter=0;
    
    for N = 1:N_max
        i_sum_1 = 0;
        i_sum_2 = 0;
        j_2 = 0;
        
        
        for Mindex = 1:M-1
            j_2 = j_2 + (random('rician',sqrt(V/(1+V)*Omega),sqrt(Omega/(2*(V+1)))))^2;
        end
        
        
        
        f_1 = (random('rician',sqrt(V/(1+V)*Omega),sqrt(Omega/(2*(V+1)))))^2;
        f_2 = (random('rician',sqrt(V/(1+V)*Omega),sqrt(Omega/(2*(V+1)))))^2;

       %bernoulli distribution
        i_1 = random('binomial',1,q);
        i_2 = random('binomial',1,q);
       
        
        if (p_P0*i_1*f_1/(2*p_N0+j_2*p_Pj)+p_P0*i_2*f_2/(2*p_N0+j_2*p_Pj))< p_gamma_k
            outage_counter =outage_counter+1;
        end
    end
    pr_simu_sub(Pindex) = outage_counter/N_max
                     
    pr_anal_sub_infty_3(Pindex) = (1-0.3)^2;   
    pr_anal_sub_infty_5(Pindex) = (1-0.5)^2;
    pr_anal_sub_infty_7(Pindex) = (1-0.7)^2;
    
    
end




%plot 
p1=semilogy(P0,pr_anal_sub_3_3,'-');
ax = gca;
ax.FontSize=16;
ax.YLim = [0.03,1];
grid on
p1.Color='Red';
p1.LineWidth=2;
xlabel('Transmission Power (P_0)','FontSize',16)
ylabel('Eavesdropping Channel Transmission Outage Probability','FontSize',12)

hold on;
p2=semilogy(P0,pr_simu_sub_3_3,'v');
p2.Color='Red';
p2.MarkerSize=10;
p2.LineWidth=2;

p3=semilogy(P0,pr_anal_sub_6_3,'-');
p3.Color='Green';
p3.LineWidth=2;

p4=semilogy(P0,pr_simu_sub_6_3,'o');
p4.Color='Green';
p4.MarkerSize=10;

p5=semilogy(P0,pr_anal_sub_10_3,'-');
p5.Color='Blue';
p5.LineWidth=2;

p6=semilogy(P0,pr_simu_sub_10_3,'^');
p6.Color='Blue';
p6.MarkerSize=10;

p7=semilogy(P0,pr_anal_sub_3_5,'-');
p7.Color='Red';
p7.LineWidth=2;

p8=semilogy(P0,pr_simu_sub_3_5,'v');
p8.Color='Red';
p8.MarkerSize=10;

p9=semilogy(P0,pr_anal_sub_6_5,'-');
p9.Color='Green';
p9.LineWidth=2;

p10=semilogy(P0,pr_simu_sub_6_5,'o');
p10.Color='Green';
p10.MarkerSize=10;

p11=semilogy(P0,pr_anal_sub_10_5,'-');
p11.Color='Blue';
p11.LineWidth=2;

p12=semilogy(P0,pr_simu_sub_10_5,'^');
p12.Color='Blue';
p12.MarkerSize=10;

p13=semilogy(P0,pr_anal_sub_3_7,'-');
p13.Color='Red';
p13.LineWidth=2;

p14=semilogy(P0,pr_simu_sub_3_7,'v');
p14.Color='Red';
p14.MarkerSize=10;

p15=semilogy(P0,pr_anal_sub_6_7,'-');
p15.Color='Green';
p15.LineWidth=2;

p16=semilogy(P0,pr_simu_sub_6_7,'o');
p16.Color='Green';
p16.MarkerSize=10;

p17=semilogy(P0,pr_anal_sub,'-');
p17.Color='Blue';
p17.LineWidth=2;

p18=semilogy(P0,pr_simu_sub,'^');
p18.Color='Blue';
p18.MarkerSize=10;

p19=semilogy(P0,pr_anal_sub_infty_3,'--');
p19.Color='Black';
p19.LineWidth=2;

p20=semilogy(P0,pr_anal_sub_infty_5,'--');
p20.Color='Black';
p20.LineWidth=2;

p21=semilogy(P0,pr_anal_sub_infty_7,'--');
p21.Color='Black';
p21.LineWidth=2;

p0=semilogy(P0,pr_simple,'-');
p0.Color='Black';
p0.LineWidth=2;




lgd=legend([p0,p2,p4,p6],'Anal.','M=3','M=6','M=10');
% set(lgd,'Interpreter','latex')
lgd.FontSize=16;
lgd.Location='southwest';

text(16,0.65,'q=0.3 \downarrow','FontSize',14);
text(16,0.35,'q=0.5 \downarrow','FontSize',14);
text(16,0.12,'q=0.7 \downarrow','FontSize',14);

fname = '/users/shin/dropbox/programming/matlab';
saveas(p1,fullfile(fname,'sub_fig'),'fig');
